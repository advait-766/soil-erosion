# -*- coding: utf-8 -*-
"""
/***************************************************************************
 Smoderp2DDockWidget
                                 A QGIS plugin
 This plugin computes hydrological erosion model.
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                             -------------------
        begin                : 2018-10-10
        git sha              : $Format:%H$
        copyright            : (C) 2018 by CTU
        email                : petr.kavka@fsv.cvut.cz
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""

import os
import sys

sys.path.insert(0, os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', '..', '..'))

from PyQt5 import QtWidgets, uic
from PyQt5.QtCore import pyqtSignal, QFileInfo, QSettings

from PyQt5.QtWidgets import QFileDialog
from qgis.core import QgsProviderRegistry, QgsMapLayerProxyModel, QgsVectorLayer, QgsRasterLayer
from qgis.utils import iface
from qgis.gui import QgsMapLayerComboBox, QgsFieldComboBox

from smoderp2d.exceptions import ProviderError
from smoderp2d import QGISRunner
from .connect_grass import findGrass as fg

FORM_CLASS, _ = uic.loadUiType(os.path.join(
    os.path.dirname(__file__), 'smoderp_2D_dockwidget_base.ui'))


class InputError(Exception):
    def __init__(self):
        pass


class Smoderp2DDockWidget(QtWidgets.QDockWidget, FORM_CLASS):

    closingPlugin = pyqtSignal()

    def __init__(self, parent=None):
        """Constructor."""
        super(Smoderp2DDockWidget, self).__init__(parent)
        # Set up the user interface from Designer.
        # After setupUI you can access any designer object by doing
        # self.<objectname>, and you can use autoconnect slots - see
        # http://qt-project.org/doc/qt-4.8/designer-using-a-ui-file.html
        # #widgets-and-dialogs-with-auto-connect
        self.setupUi(self)

        self.iface = iface

        self.settings = QSettings("CTU", "smoderp")

        self.setup_buttons()

        self.setup_combos()

    def closeEvent(self, event):
        self.closingPlugin.emit()
        event.accept()

    def setup_buttons(self):
        """Setup buttons slots."""

        # TODO: what if tables are in format that cannot be added to map? (txt), currently works for dbf

        self.run_dataprep.clicked.connect(self.on_run_button)

        # 1st tab - Data preparation
        self.elevation_toolButton.clicked.connect(lambda: self.open_file_dialog('raster', self.elevation_comboBox))
        self.soil_toolButton.clicked.connect(lambda: self.open_file_dialog('vector', self.soil_comboBox))
        self.vegetation_toolButton.clicked.connect(lambda: self.open_file_dialog('vector', self.vegetation_comboBox))
        self.points_toolButton.clicked.connect(lambda: self.open_file_dialog('vector', self.points_comboBox))
        self.output_toolButton.clicked.connect(lambda: self.open_file_dialog('folder', self.output_lineEdit))
        self.stream_toolButton.clicked.connect(lambda: self.open_file_dialog('vector', self.stream_comboBox))

        self.soil_comboBox.layerChanged.connect(lambda: self.set_fields('soil'))
        self.vegetation_comboBox.layerChanged.connect(lambda: self.set_fields('vegetation'))

        # 2nd tab - Computation
        self.pickle_toolButton.clicked.connect(lambda: self.open_file_dialog('file', self.pickle_lineEdit))
        self.rainfall_toolButton.clicked.connect(lambda: self.open_file_dialog('file', self.rainfall_lineEdit))

        # 3rd tab - Settings
        self.table_soil_vegetation_toolButton.clicked.connect(lambda: self.open_file_dialog(
            'table', self.table_soil_vegetation_comboBox))
        self.table_stream_shape_toolButton.clicked.connect(lambda: self.open_file_dialog(
            'table', self.table_stream_shape_comboBox))
        self.main_output_toolButton.clicked.connect(lambda: self.open_file_dialog('folder', self.main_output_lineEdit))

        self.table_soil_vegetation_comboBox.layerChanged.connect(lambda: self.set_fields('table_soil_veg'))
        self.table_stream_shape_comboBox.layerChanged.connect(lambda: self.set_fields('table_stream_shape'))

    def setup_combos(self):
        """Setup combo boxes."""

        # 1st tab - Data preparation
        self.elevation_comboBox.setFilters(QgsMapLayerProxyModel.RasterLayer)
        self.soil_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)
        self.vegetation_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)
        self.points_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)
        self.stream_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)

        self.set_fields('soil')
        self.set_fields('vegetation')

        # 3rd tab - Settings
        self.table_soil_vegetation_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)
        self.table_stream_shape_comboBox.setFilters(QgsMapLayerProxyModel.VectorLayer)

        self.set_fields('table_soil_veg')
        self.set_fields('table_stream_shape')

    def on_run_button(self):

        if self._check_input_data_prep():

            # Get grass
            grass7bin = fg()

            # Get input parameters
            self._get_input_params()

            try:
                runner = QGISRunner()

            except ProviderError as e:
                raise ProviderError(e)

        else:
            self.send_message("Input parameters error:",
                              "Some of mandatory fields are not filled correctly.",
                              "CRITICAL")

    def _get_input_params(self):
        """Get input parameters from QGIS plugin."""

        self._input_params = {
            'elevation': self.elevation_comboBox.currentLayer().dataProvider().dataSourceUri(),
            'soil': self.soil_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0],
            'soil_type': self.soil_type_comboBox.currentText(),
            'vegetation': self.vegetation_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0],
            'vegetation_type': self.vegetation_type_comboBox.currentText(),
            'points': "",
            'output': self.output_lineEdit.text().strip(),
            'stream': "",
            'pickle': self.pickle_lineEdit.text().strip(),
            'rainfall_file': self.rainfall_lineEdit.text(),
            'end_time': float(self.end_time_lineEdit.text()) * 60.0,  # to seconds
            'maxdt': float(self.maxdt_lineEdit.text()),
            'table_soil_vegetation':
                self.table_soil_vegetation_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0],
            'table_soil_vegetation_code': self.table_soil_vegetation_code_comboBox.currentText(),
            'table_stream_shape': "",
            'table_stream_shape_code': "",
            'main_output': self.main_output_lineEdit.text().strip()
        }

        # optional inputs
        if self.points_comboBox.currentLayer() is not None:
            self._input_params["points"] = \
                self.points_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0]

        if self.stream_comboBox.currentLayer() is not None:
            self._input_params["stream"] = \
                self.stream_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0]

        if self.table_stream_shape_comboBox.currentLayer() is not None:
            self._input_params["table_stream_shape"] = \
                self.table_stream_shape_comboBox.currentLayer().dataProvider().dataSourceUri().split('|', 1)[0]
            self._input_params["table_stream_shape_code"] = self.table_stream_shape_code_comboBox.currentText()

    def _check_input_data_prep(self):
        """Check if all mandatory fields are filled correctly for data preparation (without pickle)."""

        # Check if none of fields are empty
        if None not in (
                self.elevation_comboBox.currentLayer(),
                self.soil_comboBox.currentLayer(),
                self.soil_type_comboBox.currentText(),
                self.vegetation_comboBox.currentLayer(),
                self.vegetation_type_comboBox.currentText(),
                self.table_soil_vegetation_comboBox.currentLayer(),
                self.table_soil_vegetation_code_comboBox.currentText(),
                ) and "" not in (
                self.output_lineEdit.text().strip(),
                self.maxdt_lineEdit.text().strip(),
                self.rainfall_lineEdit.text().strip(),
                self.end_time_lineEdit.text().strip(),
                self.main_output_lineEdit.text().strip()
        ):
            # Check if maxdt and end_time are numbers
            try:
                float(self.maxdt_lineEdit.text())
                float(self.end_time_lineEdit.text())
                return True
            except ValueError:
                return False
        else:
            return False

    def _check_input_comp(self):
        """Check if pickle field is filled correctly for further computation."""
        if self.pickle_lineEdit.text().strip() == "":
            return False
        else:
            return True

    def open_file_dialog(self, t, widget):
        """Open file dialog."""

        # TODO: what format can tables have?

        # remember last folder where user was in
        sender = u'{}-last_used_file_path'.format(self.sender().objectName())
        last_used_file_path = self.settings.value(sender, '')

        if t == 'vector':
            file_name = QFileDialog.getOpenFileName(self, self.tr(u'Open file'),
                                                    self.tr(u'{}').format(last_used_file_path),
                                                    QgsProviderRegistry.instance().fileVectorFilters())[0]
            if file_name:
                name, file_extension = os.path.splitext(file_name)
                if file_extension not in QgsProviderRegistry.instance().fileVectorFilters():
                    self.send_message(u'Error', u'{} is not a valid vector layer.'.format(file_name), 'CRITICAL')
                    return
                else:
                    self.iface.addVectorLayer(file_name, QFileInfo(file_name).baseName(), "ogr")
                    widget.setLayer(self.iface.activeLayer())
                    self.settings.setValue(sender, os.path.dirname(file_name))

        elif t == 'raster':
            file_name = QFileDialog.getOpenFileName(self, self.tr(u'Open file'),
                                                    self.tr(u'{}').format(last_used_file_path),
                                                    QgsProviderRegistry.instance().fileRasterFilters())[0]
            if file_name:
                name, file_extension = os.path.splitext(file_name)

                if file_extension not in QgsProviderRegistry.instance().fileRasterFilters():
                    self.send_message(u'Error', u'{} is not a valid raster layer.'.format(file_name), 'CRITICAL')
                    return

                self.iface.addRasterLayer(file_name, QFileInfo(file_name).baseName())
                widget.setLayer(self.iface.activeLayer())
                self.settings.setValue(sender, os.path.dirname(file_name))

        elif t == 'folder':
            folder_name = QFileDialog.getExistingDirectory(self, self.tr(u'Select directory'),
                                                           self.tr(u'{}').format(last_used_file_path))

            if os.access(folder_name, os.W_OK):
                widget.setText(folder_name)
                self.settings.setValue(sender, os.path.dirname(folder_name))
            elif folder_name == "":
                pass
            else:
                self.send_message(u'Error', u'{} is not writable.'.format(folder_name), 'CRITICAL')

        elif t == 'table':
            # write path to file to lineEdit
            file_name = QFileDialog.getOpenFileName(self, self.tr(u'Open file'),
                                                    self.tr(u'{}').format(last_used_file_path))[0]

            if file_name:
                self.iface.addVectorLayer(file_name, QFileInfo(file_name).baseName(), "ogr")
                widget.setLayer(self.iface.activeLayer())
                self.settings.setValue(sender, os.path.dirname(file_name))

        elif t == 'file':
            # write path to file to lineEdit
            file_name = QFileDialog.getOpenFileName(self, self.tr(u'Open file'),
                                                    self.tr(u'{}').format(last_used_file_path))[0]

            if file_name:
                widget.setText(file_name)
                self.settings.setValue(sender, os.path.dirname(file_name))
        else:
            pass

    def set_fields(self, t):
        """Set fields of soil and vegetation type."""

        if self.soil_comboBox.currentLayer() is not None and t == 'soil':
            self.soil_type_comboBox.setLayer(self.soil_comboBox.currentLayer())
            self.soil_type_comboBox.setField(self.soil_comboBox.currentLayer().fields()[0].name())

        elif self.vegetation_comboBox.currentLayer() is not None and t == 'vegetation':
            self.vegetation_type_comboBox.setLayer(self.vegetation_comboBox.currentLayer())
            self.vegetation_type_comboBox.setField(self.vegetation_comboBox.currentLayer().fields()[0].name())

        elif self.table_soil_vegetation_comboBox.currentLayer() is not None and t == 'table_soil_veg':
            self.table_soil_vegetation_code_comboBox.setLayer(self.table_soil_vegetation_comboBox.currentLayer())
            self.table_soil_vegetation_code_comboBox.setField(
                self.table_soil_vegetation_comboBox.currentLayer().fields()[0].name())

        elif t == 'table_stream_shape':
            if self.table_stream_shape_comboBox.currentLayer() is not None:
                self.table_stream_shape_code_comboBox.setLayer(self.table_stream_shape_comboBox.currentLayer())
                self.table_stream_shape_code_comboBox.setField(
                    self.table_stream_shape_comboBox.currentLayer().fields()[0].name())
            else:
                self.table_stream_shape_code_comboBox.setLayer(None)
                self.table_stream_shape_code_comboBox.setField("")

        else:
            pass

    def send_message(self, caption, message, t):
        if t == 'CRITICAL':
            self.iface.messageBar().pushCritical(self.tr(u'{}').format(caption),
                                                 self.tr(u'{}').format(message))
        elif t == 'INFO':
            self.iface.messageBar().pushInfo(self.tr(u'{}').format(caption),
                                             self.tr(u'{}').format(message))
